<queries>
    <query name="com.icsd.ele.log.entry" coreTable="" flattened="false">
        <description>Retrieve log information submitted by the current user for the current student</description>
        <args>
          <arg name="userid" description="USERS.id" type="primitive" required="false" />
          <arg name="studentid" description="STUDENTS.id" type="primitive" required="false" />
        </args>
        <columns>
          <column column="log.dcid">log_dcid</column>
          <column column="log.entry_date">entry_date</column>
          <column column="log.entry_time">hours</column>
          <column column="log.entry_time">minutes</column>
          <column column="log.entry_time">ampm</column>
          <column column="log.entry_author">entry_author</column>
          <column column="log.subject">subject</column>
          <column column="log.entry">entry</column>
          <column column="gen.name">name</column>
          <column column="students.dcid">students_dcid</column>
          <column column="gen.valuet">log_subtype</column>
     		</columns>
        <sql>
			<![CDATA[
        SELECT
          lg.dcid log_dcid,
          lg.entry_date,
          substr('00' || to_char(FLOOR(((lg.entry_time - MOD(lg.entry_time, 60)) / 60) / 60)), -2, 2) Hours,
          substr('00' || to_char(MOD(((lg.entry_time - (MOD(lg.entry_time, 60))) / 60), 60)), -2, 2)  Minutes,
          CASE
          WHEN lg.entry_time < 43200
            THEN 'AM'
          ELSE 'PM'
          END,
          lg.entry_author,
          lg.subject,
          lg.entry,
          g.name,
          s.dcid students_dcid,
          st.ValueT subtype
        FROM log lg
          INNER JOIN gen g ON lg.logtypeid = g.id
          INNER JOIN students s ON lg.studentid = s.id
          LEFT OUTER JOIN gen st ON st.Name = to_char(g.ID)
              AND st.value = lg.subtype
              AND st.Cat = 'subtype'
        WHERE lg.studentid = :studentid
        AND (SELECT to_char(gp.ValueT2) FROM Teachers t INNER JOIN Gen gp ON t.groupValue = gp.ID WHERE t.ID = :userid AND gp.cat = 'groups') LIKE '%' || lg.LogTypeID || '%'
        ORDER BY lg.entry_date DESC, lg.Entry_Time DESC
			]]>
        </sql>
    </query>
</queries>
