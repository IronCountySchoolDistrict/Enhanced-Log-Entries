[
    ~[tlist_sql;
        SELECT
            lg.dcid ldcid,
            s.dcid sdcid,
            g.name,
            lg.entry_date,
            substr('00' || to_char(FLOOR(((lg.entry_time-MOD(lg.entry_time, 60))/60)/60)),-2,2) Hours,
            substr('00' || to_char(MOD(((lg.entry_time-(MOD(lg.entry_time, 60)))/60),60)),-2,2) Minutes,
            CASE
                WHEN lg.entry_time < 43200 THEN 'AM'
                ELSE 'PM'
            END ampm,
            lg.entry_author,
            to_char(st.ValueT) subtype,
            --Escape all invalid JSON characters. Make sure to escape backslash first or other escaped chars will have 2 backslashes instead of 1.
            --Don't try to use ;js below to escape characters, it will escape single quotes with "\'" which breaks JSON parsing
            replace(replace(replace(replace(replace(replace(replace(lg.subject, chr(92), '\\'), chr(34), '\"'), chr(47), '\/'), chr(12), '\f'), chr(10), '\n'), chr(13), '\r'), chr(9), '\t') subject,
            replace(replace(replace(replace(replace(replace(replace(lg.entry, chr(92), '\\'), chr(34), '\"'), chr(47), '\/'), chr(12), '\f'), chr(10), '\n'), chr(13), '\r'), chr(9), '\t') logText
        FROM log lg
        INNER JOIN ps.students s ON lg.studentid = s.id
        INNER JOIN ps.gen g ON lg.logtypeid = g.id
        LEFT OUTER JOIN ps.gen st ON st.Name = to_char(g.ID)
            AND st.value = lg.subtype
            AND st.Cat = 'subtype'
        WHERE lg.studentid = ~[gpv:curstudid]
        AND (SELECT to_char(gp.ValueT2) FROM Teachers t INNER JOIN Gen gp ON t.groupValue = gp.ID WHERE t.ID = ~[x:userid] AND gp.cat = 'groups') LIKE '%' || lg.LogTypeID || '%'
        order by lg.entry_date DESC, lg.Entry_Time DESC
    ]
        {
            "gpvfields": ["curstudid", "teacherid"],
            "logDCID": "~(ldcid;js)",
            "studentDCID": "~(sdcid;js)",
            "name": "~(name;js)",
            "entryDate": "~(entry_date;js)",
            "hours": "~(Hours;js)",
            "minutes": "~(Minutes;js)",
            "ampm": "~(ampm;js)",
            "entryAuthor": "~(entry_author;js)",
            "subType": "~(subtype;js)",
            "subject": "~(subject)",
            "logText": "~(logText)"
        },
    [/tlist_sql]{}
]
